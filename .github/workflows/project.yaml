name: Add issues and PRs to project

on:
  issues:
    types:
      - opened
  pull_request:
    types:
      - opened
      - closed

env:
  PROJECT_ORG: YOUR_ORG_HERE  # Replace with your GitHub organization
  PROJECT_ID: YOUR_PROJECT_ID_HERE  # Replace with your project number (e.g., 3)

jobs:
  add-to-project:
    name: Add to project
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      # Add issues to project with Status "Proposed"
      - name: Add issue to project
        if: github.event_name == 'issues'
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/${{ env.PROJECT_ORG }}/projects/${{ env.PROJECT_ID }}
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          status-field: Status
          status-value: Proposed

      # Add PRs to project without setting status
      - name: Add PR to project
        if: github.event_name == 'pull_request'
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/${{ env.PROJECT_ORG }}/projects/${{ env.PROJECT_ID }}
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

  close-linked-issues:
    name: Close linked issues
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Get linked issues
        id: get-issues
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          # Query PR for linked issues using closingIssuesReferences
          pr_number="${{ github.event.pull_request.number }}"
          repo_owner="${{ github.repository_owner }}"
          repo_name="${{ github.event.repository.name }}"

          echo "Querying linked issues for PR #$pr_number..."

          linked_issues=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $prNumber: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $prNumber) {
                  closingIssuesReferences(first: 10) {
                    nodes {
                      number
                      id
                    }
                  }
                }
              }
            }
          ' -f owner="$repo_owner" -f repo="$repo_name" -F prNumber="$pr_number" --jq '.data.repository.pullRequest.closingIssuesReferences.nodes')

          echo "linked_issues<<EOF" >> $GITHUB_OUTPUT
          echo "$linked_issues" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Found linked issues:"
          echo "$linked_issues" | jq -r '.[] | "  - Issue #\(.number) (ID: \(.id))"'

      - name: Close linked issues
        if: steps.get-issues.outputs.linked_issues != '[]'
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          linked_issues='${{ steps.get-issues.outputs.linked_issues }}'

          # Process each linked issue
          echo "$linked_issues" | jq -c '.[]' | while read -r issue; do
            issue_number=$(echo "$issue" | jq -r '.number')
            echo "Closing issue #$issue_number..."
            gh issue close "$issue_number" -R "$GITHUB_REPOSITORY" --reason "completed"
            echo "  Issue #$issue_number closed"
          done

          echo ""
          echo "All linked issues closed successfully!"

  archive-pr-on-merge:
    name: Archive merged PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Get project node ID
        id: get-project
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          echo "Fetching project node ID for ${{ env.PROJECT_ORG }}/projects/${{ env.PROJECT_ID }}..."

          project_node_id=$(gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                }
              }
            }
          ' -f org="${{ env.PROJECT_ORG }}" -F number="${{ env.PROJECT_ID }}" --jq '.data.organization.projectV2.id')

          if [ -z "$project_node_id" ] || [ "$project_node_id" = "null" ]; then
            echo "Error: Could not find project ${{ env.PROJECT_ORG }}/projects/${{ env.PROJECT_ID }}"
            exit 1
          fi

          echo "project_node_id=$project_node_id" >> $GITHUB_OUTPUT
          echo "Found project: $project_node_id"

      - name: Find PR item in project
        id: find-item
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          project_id="${{ steps.get-project.outputs.project_node_id }}"
          pr_node_id="${{ github.event.pull_request.node_id }}"

          echo "Searching for PR item in project..."
          echo "  PR node ID: $pr_node_id"

          item_id=""
          cursor=""
          page=1
          max_pages=5  # Limit to 500 items; very large projects should use GitHub's built-in auto-archive

          while [ $page -le $max_pages ]; do
            echo "  Fetching page $page..."

            if [ -z "$cursor" ]; then
              result=$(gh api graphql -f query='
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        pageInfo {
                          hasNextPage
                          endCursor
                        }
                        nodes {
                          id
                          content {
                            ... on PullRequest {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                }
              ' -f projectId="$project_id")
            else
              result=$(gh api graphql -f query='
                query($projectId: ID!, $cursor: String!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100, after: $cursor) {
                        pageInfo {
                          hasNextPage
                          endCursor
                        }
                        nodes {
                          id
                          content {
                            ... on PullRequest {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                }
              ' -f projectId="$project_id" -f cursor="$cursor")
            fi

            # Find matching item
            item_id=$(echo "$result" | jq -r --arg pr_id "$pr_node_id" '
              .data.node.items.nodes[] |
              select(.content.id == $pr_id) |
              .id
            ' | head -1)

            if [ -n "$item_id" ] && [ "$item_id" != "null" ]; then
              echo "  Found PR item: $item_id"
              break
            fi

            # Check for more pages
            has_next=$(echo "$result" | jq -r '.data.node.items.pageInfo.hasNextPage')
            if [ "$has_next" != "true" ]; then
              echo "  No more pages"
              break
            fi

            cursor=$(echo "$result" | jq -r '.data.node.items.pageInfo.endCursor')
            page=$((page + 1))
          done

          if [ -z "$item_id" ] || [ "$item_id" = "null" ]; then
            echo "PR not found in project (may not have been added)"
            echo "item_id=" >> $GITHUB_OUTPUT
          else
            echo "item_id=$item_id" >> $GITHUB_OUTPUT
          fi

      - name: Archive PR item
        if: steps.find-item.outputs.item_id != ''
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          project_id="${{ steps.get-project.outputs.project_node_id }}"
          item_id="${{ steps.find-item.outputs.item_id }}"

          echo "Archiving PR item $item_id..."

          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!) {
              archiveProjectV2Item(input: {projectId: $projectId, itemId: $itemId}) {
                item {
                  id
                }
              }
            }
          ' -f projectId="$project_id" -f itemId="$item_id"

          echo "PR item archived successfully!"
